stages:
  - deploy
  - monitor

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client sshpass
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - |
      sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER << 'DEPLOY_SCRIPT'
        cd $DEPLOY_PATH
        git fetch --all
        git checkout main
        docker compose down --remove-orphans
        docker compose build --no-cache
        docker compose up -d
      DEPLOY_SCRIPT
  only:
    - main

monitor-logs:
  stage: monitor
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client sshpass curl grep
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - |
      echo "ğŸ“Š Starting log monitoring..."

      # Fetch recent logs from backend container
      RECENT_LOGS=$(sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "cd $DEPLOY_PATH && docker logs dongsung-backend --tail 100 2>&1")

      # Count auth failures
      AUTH_FAILS=$(echo "$RECENT_LOGS" | grep -c '\[AUTH_FAIL\]' || true)

      echo ""
      echo "=== ğŸ” ë¡œê·¸ ë¶„ì„ ê²°ê³¼ ==="
      echo "ì¸ì¦ ì‹¤íŒ¨: $AUTH_FAILSê±´"

      if [ "$AUTH_FAILS" -gt "0" ]; then
        echo ""
        echo "âš ï¸  ì¸ì¦ ì‹¤íŒ¨ ë‚´ì—­:"
        echo "$RECENT_LOGS" | grep '\[AUTH_FAIL\]' || true
      fi

      # Check for critical errors
      ERRORS=$(echo "$RECENT_LOGS" | grep -i 'error' | grep -v 'DEBUG\|proxyError' || true)
      if [ -n "$ERRORS" ]; then
        echo ""
        echo "âŒ ì—ëŸ¬ ë°œê²¬:"
        echo "$ERRORS" | head -5
      fi

      # Check server status
      SERVER_RUNNING=$(echo "$RECENT_LOGS" | grep -c 'Server is running' || true)
      if [ "$SERVER_RUNNING" -gt "0" ]; then
        echo ""
        echo "âœ… ì„œë²„ ìƒíƒœ: ì •ìƒ ìš´ì˜ ì¤‘"
      fi

      echo ""
      echo "=== ğŸ“‹ ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 10ì¤„) ==="
      echo "$RECENT_LOGS" | tail -10

  only:
    - main
  allow_failure: true
